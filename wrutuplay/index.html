<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wrutulang Playground</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        h1 {
            color: #333;
        }
        #editor {
            width: 80%;
            height: 300px;
            margin: 20px 0;
            padding: 10px;
            border: 1px solid #ccc;
            background-color: #fff;
            font-family: 'Courier New', Courier, monospace;
            line-height: 1.5;
            resize: vertical;
            overflow: auto;
        }
        #output {
            width: 80%;
            min-height: 100px;
            margin: 20px 0;
            padding: 10px;
            border: 1px solid #ccc;
            background-color: #fff;
            white-space: pre-wrap;
        }
        #runButton {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #28a745;
            color: #fff;
            border: none;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>Wrutulang Playground</h1>
    <textarea id="editor" placeholder="Digite seu cÃ³digo Wrutulang aqui..."></textarea>
    <button id="runButton">Executar</button>
    <div id="output"></div>

    <script>
        const functions = {};
        const variables = {};
        const running_while = [false];

        class Executor {
            constructor(code) {
                this.code = code;
            }

            execute1() {
                const lines = this.code.split("\n");
                let in_func = [false];
                let endnum = 0;
                let funcname = [""];

                for (let line of lines) {
                    const tokens = line.trim().split(/\s+/);

                    if (tokens.length > 0) {
                        const token = tokens[0];

                        if (!in_func[0]) {
                            if (token === "fnc") {
                                funcname[0] = tokens[1];
                                if (tokens[2] === "[") {
                                    endnum++;
                                    in_func[0] = true;
                                    functions[funcname[0]] = [];
                                }
                            } else if (token !== "&&" && token !== "" && token !== "]") {
                                console.error("Error: You can only create functions outside of a function");
                                return;
                            }
                        } else if (in_func[0]) {
                            if (token === "if" || token === "while") {
                                endnum++;
                                functions[funcname[0]].push(line);
                            } else if (token === "]") {
                                if (endnum > 0) {
                                    endnum--;
                                    functions[funcname[0]].push(line);
                                }
                                if (endnum === 0) {
                                    in_func[0] = false;
                                    functions[funcname[0]].pop();
                                }
                            } else {
                                functions[funcname[0]].push(line);
                            }
                        }
                    }
                }

                if (functions["main"]) {
                    new Executor(functions["main"].join("\n")).execute2();
                }
            }

            execute2() {
                const lines = this.code.split("\n");
                let in_if = [false];
                let varname1 = [""];
                let operation = [""];
                let varname2 = [""];
                let ifcode = [];
                let endnum = 0;
                let in_while = [false];
                let while_code = [];

                for (let line of lines) {
                    const tokens = line.trim().split(/\s+/);

                    if (tokens.length > 0) {
                        const token = tokens[0];

                        if (!in_if[0] && !in_while[0]) {
                            switch (token) {
                                case "showln":
                                    if (tokens[1] === "\"") {
                                        if (tokens[tokens.length - 1] === "\"") {
                                            const msg = tokens.slice(2, tokens.length - 1).join(" ");
                                            document.getElementById('output').innerText += msg;
                                        } else {
                                            console.error("Error: use \" to close a string");
                                            return;
                                        }
                                    } else if (tokens[1] === "\\n") {
                                        document.getElementById('output').innerText += "\n";
                                    } else if (tokens[1] === "\\spc") {
                                        document.getElementById('output').innerText += " ";
                                    } else {
                                        document.getElementById('output').innerText += variables[tokens[1]];
                                    }
                                    break;
                                case "int":
                                    if (tokens[2] === ":") {
                                        variables[tokens[1]] = parseInt(tokens[3]);
                                    } else {
                                        console.error("Error: use : to assign a value to a variable");
                                        return;
                                    }
                                    break;
                                case "string":
                                    if (tokens[2] === ":") {
                                        variables[tokens[1]] = tokens.slice(3).join(" ");
                                    } else {
                                        console.error("Error: use : to assign a value to a variable");
                                        return;
                                    }
                                    break;
                                case "call":
                                    new Executor(functions[tokens[1]].join("\n")).execute2();
                                    break;
                                case "if":
                                    varname1[0] = tokens[1];
                                    operation[0] = tokens[2];
                                    if (tokens.length === 5) {
                                        varname2[0] = tokens[3];
                                        if (tokens[4] === "[") {
                                            in_if[0] = true;
                                            endnum++;
                                            ifcode = [];
                                        }
                                    } else {
                                        if (operation[0] === "[") {
                                            in_if[0] = true;
                                            endnum++;
                                            ifcode = [];
                                        }
                                    }
                                    break;
                                case "bool":
                                    if (tokens[2] === ":") {
                                        variables[tokens[1]] = tokens[3] === "ok" ? 1 : 0;
                                    } else {
                                        console.error("Error: use : to assign a value to a variable");
                                        return;
                                    }
                                    break;
                                case "while":
                                    if (tokens[1] === "[") {
                                        in_while[0] = true;
                                        while_code = [];
                                        endnum++;
                                        running_while[0] = true;
                                    } else {
                                        console.error("Error: use [ to open a while loop");
                                        return;
                                    }
                                    break;
                                case "stop":
                                    running_while[0] = false;
                                    break;
                                case "mod":
                                    if (tokens[2] === "<") {
                                        variables[tokens[1]] += variables[tokens[3]];
                                    } else {
                                        console.error("Error: use < to modify the second variable to the first variable");
                                        return;
                                    }
                                    break;
                                case "input":
                                    if (tokens[1] === "int") {
                                        variables[tokens[2]] = parseInt(prompt("Enter a number:"));
                                    } else if (tokens[1] === "string") {
                                        variables[tokens[2]] = prompt("Enter a string:");
                                    }
                                    break;
                                case "float":
                                    if (tokens[2] === ":") {
                                        variables[tokens[1]] = parseFloat(tokens[3]);
                                    } else {
                                        console.error("Error: use : to assign a value to a variable");
                                        return;
                                    }
                                    break;
                                case "rand":
                                    const varname11 = parseInt(tokens[1]);
                                    const varname22 = parseInt(tokens[2]);
                                    const outputvar = tokens[3];
                                    variables[outputvar] = Math.floor(Math.random() * (varname22 - varname11 + 1)) + varname11;
                                    break;
                                case "list":
                                    variables[tokens[1]] = [];
                                    break;
                                case "listapp":
                                    variables[tokens[1]].push(variables[tokens[2]]);
                                    break;
                                case "listpop":
                                    variables[tokens[1]].pop();
                                    break;
                                case "getlistitem":
                                    if (tokens[3] === ">") {
                                        variables[tokens[4]] = variables[tokens[1]][parseInt(tokens[2])];
                                    } else {
                                        console.error("Error: use > to reference the output variable");
                                        return;
                                    }
                                    break;
                                case "split":
                                    variables[tokens[2]] = variables[tokens[1]].split(" ");
                                    break;
                                default:
                                    console.error(`Error: unknown token: ${token}`);
                                    return;
                            }
                        } else if (in_if[0]) {
                        if (token === "if" || token === "while") {
                            endnum++;
                            ifcode.push(line);
                        } else if (token === "]") {
                            if (endnum > 0) {
                                endnum--;
                                ifcode.push(line);
                            }
                            if (endnum === 0) {
                                in_if[0] = false;
                                if (operation[0] === "=") {
                                    if (variables[varname1[0]] === variables[varname2[0]]) {
                                        new Executor(ifcode.join("\n")).execute2();
                                    }
                                } else if (operation[0] === "!") {
                                    if (variables[varname1[0]] !== variables[varname2[0]]) {
                                        new Executor(ifcode.join("\n")).execute2();
                                    }
                                } else if (operation[0] === ">>") {
                                    if (variables[varname1[0]] >= variables[varname2[0]]) {
                                        new Executor(ifcode.join("\n")).execute2();
                                    }
                                } else if (operation[0] === "<<") {
                                    if (variables[varname1[0]] <= variables[varname2[0]]) {
                                        new Executor(ifcode.join("\n")).execute2();
                                    }
                                } else if (operation[0] === ">") {
                                    if (variables[varname1[0]] > variables[varname2[0]]) {
                                        new Executor(ifcode.join("\n")).execute2();
                                    }
                                } else if (operation[0] === "<") {
                                    if (variables[varname1[0]] < variables[varname2[0]]) {
                                        new Executor(ifcode.join("\n")).execute2();
                                    }
                                } else if (operation[0] === "[") {
                                    if (variables[varname1[0]]) {
                                        new Executor(ifcode.join("\n")).execute2();
                                    }
                                }
                            }
                        } else {
                            ifcode.push(line);
                        }
                    } else if (in_while[0]) {
                        if (token === "if" || token === "while") {
                            endnum++;
                            while_code.push(line);
                        } else if (token === "]") {
                            if (endnum > 0) {
                                endnum--;
                                while_code.push(line);
                            }
                            if (endnum === 0) {
                                in_while[0] = false;
                                while (running_while[0]) {
                                    new Executor(while_code.join("\n")).execute2();
                                }
                            }
                        } else {
                            while_code.push(line);
                        }
                    }
                }
            }
        }
    }

    document.getElementById('runButton').addEventListener('click', () => {
        const code = document.getElementById('editor').value;
        document.getElementById('output').innerText = '';
        functions['main'] = code.split('\n');
        new Executor(code).execute1();
    });
</script>
</body>
</html>
