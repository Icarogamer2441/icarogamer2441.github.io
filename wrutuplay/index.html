<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wrutulang Playground</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
        }
        .container {
            max-width: 800px;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        textarea {
            width: 100%;
            height: 200px;
            padding: 10px;
            font-family: monospace;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        button {
            padding: 10px 15px;
            font-size: 16px;
            color: white;
            background-color: #007BFF;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .output {
            white-space: pre-wrap;
            background: #f8f9fa;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            height: 200px;
            overflow: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Wrutulang Playground</h1>
        <textarea id="codeEditor" placeholder="Enter your wrutulang code here..."></textarea>
        <button id="executeButton">Execute</button>
        <div class="output" id="output"></div>
    </div>

    <script>
        const functions = {};
        const variables = {};
        let running_while = false;

        class Executor {
            constructor(code) {
                this.code = code;
            }

            execute1() {
                const lines = this.code.split('\n');
                let in_func = false;
                let endnum = 0;
                let funcname = '';

                for (const line of lines) {
                    const tokens = line.split(/\s+/);

                    if (tokens.length > 0) {
                        const token = tokens[0];

                        if (!in_func) {
                            if (token === 'fnc') {
                                funcname = tokens[1];
                                if (tokens[2] === '[') {
                                    endnum += 1;
                                    in_func = true;
                                    functions[funcname] = [];
                                }
                            } else if (token === '&&' || token === '') {
                                // skip comment or empty line
                            } else {
                                throw new Error("Error: You can only create functions outside of a function");
                            }
                        } else {
                            if (token === 'if' || token === 'while') {
                                endnum += 1;
                                functions[funcname].push(line);
                            } else if (token === ']') {
                                if (endnum > 0) {
                                    endnum -= 1;
                                    functions[funcname].push(line);
                                }
                                if (endnum <= 0) {
                                    in_func = false;
                                    endnum = 0;
                                    functions[funcname].pop();
                                }
                            } else {
                                functions[funcname].push(line);
                            }
                        }
                    }
                }
                this.execute2(functions['main'].join('\n'));
            }

            execute2(code) {
                const lines = code.split('\n');
                let in_if = false;
                let varname1 = '';
                let operation = '';
                let varname2 = '';
                let ifcode = [];
                let endnum = 0;
                let in_while = false;
                let while_code = [];

                for (const line of lines) {
                    const tokens = line.split(/\s+/);

                    if (tokens.length > 0) {
                        const token = tokens[0];

                        if (!in_if && !in_while) {
                            if (token === 'showln') {
                                if (tokens[1] === '\"') {
                                    if (tokens[tokens.length - 1] === '\"') {
                                        const msg = tokens.slice(2, tokens.length - 1).join(' ');
                                        this.printOutput(msg);
                                    } else {
                                        throw new Error("Error: use \" to close a string");
                                    }
                                } else if (tokens[1] === '\\n') {
                                    this.printOutput('\n');
                                } else if (tokens[1] === '\\spc') {
                                    this.printOutput(' ');
                                } else {
                                    this.printOutput(variables[tokens[1]]);
                                }
                            } else if (token === 'int') {
                                const varname = tokens[1];
                                if (tokens[2] === ':') {
                                    const value = parseInt(tokens[3]);
                                    variables[varname] = value;
                                } else {
                                    throw new Error("Error: use : to assign a value to a variable");
                                }
                            } else if (token === 'string') {
                                const varname = tokens[1];
                                if (tokens[2] === ':') {
                                    const value = tokens.slice(3).join(' ');
                                    variables[varname] = value;
                                } else {
                                    throw new Error("Error: use : to assign a value to a variable");
                                }
                            } else if (token === 'call') {
                                const funcname = tokens[1];
                                this.execute2(functions[funcname].join('\n'));
                            } else if (token === 'if') {
                                varname1 = tokens[1];
                                operation = tokens[2];
                                varname2 = tokens.length === 5 ? tokens[3] : '';
                                if (tokens[tokens.length - 1] === '[') {
                                    in_if = true;
                                    endnum += 1;
                                    ifcode = [];
                                }
                            } else if (token === 'bool') {
                                const varname = tokens[1];
                                if (tokens[2] === ':') {
                                    variables[varname] = tokens[3] === 'ok' ? 1 : 0;
                                } else {
                                    throw new Error("Error: use : to assign a value to a variable");
                                }
                            } else if (token === 'while') {
                                if (tokens[1] === '[') {
                                    in_while = true;
                                    while_code = [];
                                    endnum += 1;
                                    running_while = true;
                                } else {
                                    throw new Error("Error: use [ to open a while loop");
                                }
                            } else if (token === 'stop') {
                                running_while = false;
                            } else if (token === 'mod') {
                                const varname1 = tokens[1];
                                if (tokens[2] === '<') {
                                    const varname2 = tokens[3];
                                    variables[varname1] += variables[varname2];
                                } else {
                                    throw new Error("Error: use < to modify the second variable to the first variable");
                                }
                            } else if (token === 'input') {
                                const inptype = tokens[1];
                                if (inptype === 'int') {
                                    const varname = tokens[2];
                                    variables[varname] = parseInt(prompt("Enter an integer:"));
                                } else if (inptype === 'string') {
                                    const varname = tokens[2];
                                    variables[varname] = prompt("Enter a string:");
                                }
                            } else if (token === 'float') {
                                const varname = tokens[1];
                                if (tokens[2] === ':') {
                                    const value = parseFloat(tokens[3]);
                                    variables[varname] = value;
                                } else {
                                    throw new Error("Error: use : to assign a value to a variable");
                                }
                            } else if (token === 'rand') {
                                let varname1 = tokens[1];
                                let varname2 = tokens[2];
                                if (isNaN(varname1)) varname1 = variables[varname1];
                                else varname1 = parseInt(varname1);
                                if (isNaN(varname2)) varname2 = variables[varname2];
                                else varname2 = parseInt(varname2);
                                const outputvar = tokens[3];
                                variables[outputvar] = Math.floor(Math.random() * (varname2 - varname1 + 1)) + varname1;
                            } else if (token === 'list') {
                                const varname = tokens[1];
                                variables[varname] = [];
                            } else if (token === 'listapp') {
                                const listvarname = tokens[1];
                                const varname = tokens[2];
                                variables[listvarname].push(variables[varname]);
                            } else if (token === 'listpop') {
                                const listvarname = tokens[1];
                                variables[listvarname].pop();
                            } else if (token === 'getlistitem') {
                                const listvarname = tokens[1];
                                const itempos = tokens[2];
                                if (tokens[3] === '>') {
                                    const outputvar = tokens[4];
                                    if (isNaN(itempos)) variables[outputvar] = variables[listvarname][variables[itempos]];
                                    else variables[outputvar] = variables[listvarname][parseInt(itempos)];
                                } else {
                                    throw new Error("Error: use > to reference the output variable");
                                }
                            } else if (token === 'split') {
                                const varname = tokens[1];
                                const listvarname = tokens[2];
                                variables[listvarname] = variables[varname].split(' ');
                            } else if (token === '&&' || token === '') {
                                continue; // Skip comments or empty lines
                            } else {
                                throw new Error(`Error: unknown token: ${token}`);
                            }
                        } else if (in_if) {
                            if (token === 'if' || token === 'while') {
                                endnum += 1;
                                ifcode.push(line);
                            } else if (token === ']') {
                                endnum -= 1;
                                if (endnum > 0) {
                                    ifcode.push(line);
                                } else {
                                    endnum = 0;
                                    in_if = false;
                                    ifcode.pop();
                                    const condition1 = variables[varname1];
                                    const condition2 = variables[varname2];
                                    let conditionMet = false;
                                    switch (operation) {
                                        case '=':
                                            conditionMet = condition1 === condition2;
                                            break;
                                        case '!':
                                            conditionMet = condition1 !== condition2;
                                            break;
                                        case '>>':
                                            conditionMet = condition1 >= condition2;
                                            break;
                                        case '<<':
                                            conditionMet = condition1 <= condition2;
                                            break;
                                        case '>':
                                            conditionMet = condition1 > condition2;
                                            break;
                                        case '<':
                                            conditionMet = condition1 < condition2;
                                            break;
                                        case '[':
                                            conditionMet = Boolean(condition1);
                                            break;
                                    }
                                    if (conditionMet) {
                                        new Executor(ifcode.join('\n')).execute2();
                                    }
                                }
                            } else {
                                ifcode.push(line);
                            }
                        } else if (in_while) {
                            if (token === 'if' || token === 'while') {
                                endnum += 1;
                                while_code.push(line);
                            } else if (token === ']') {
                                endnum -= 1;
                                if (endnum > 0) {
                                    while_code.push(line);
                                } else {
                                    endnum = 0;
                                    in_while = false;
                                    while_code.pop();
                                    while (running_while) {
                                        new Executor(while_code.join('\n')).execute2();
                                    }
                                }
                            } else {
                                while_code.push(line);
                            }
                        }
                    }
                }
            }

            printOutput(message) {
                const outputDiv = document.getElementById('output');
                outputDiv.textContent += message + '\n';
            }
        }

        document.getElementById('executeButton').addEventListener('click', () => {
            const code = document.getElementById('codeEditor').value;
            document.getElementById('output').textContent = ''; // Clear previous output
            try {
                new Executor(code).execute1();
            } catch (error) {
                document.getElementById('output').textContent = error.message;
            }
        });
    </script>
</body>
</html>
