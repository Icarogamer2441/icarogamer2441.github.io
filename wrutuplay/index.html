<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wrutulang Playground</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        header {
            background-color: #333;
            color: #fff;
            padding: 10px 20px;
            text-align: center;
        }
        main {
            flex: 1;
            display: flex;
        }
        textarea {
            flex: 1;
            padding: 10px;
            border: none;
            resize: none;
            font-family: monospace;
            font-size: 14px;
        }
        .output {
            flex: 1;
            background-color: #f5f5f5;
            padding: 10px;
            border-left: 1px solid #ddd;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: monospace;
        }
        button {
            padding: 10px 20px;
            margin: 10px;
            font-size: 14px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <header>
        <h1>Wrutulang Playground</h1>
    </header>
    <main>
        <textarea id="codeEditor" placeholder="Escreva seu cÃ³digo Wrutulang aqui..."></textarea>
        <div id="output" class="output"></div>
    </main>
    <button id="executeButton">Execute</button>

    <script>
        const functions = {};
        const variables = {};
        let running_while = false;

        class Executor {
            constructor(code) {
                this.code = code;
            }

            execute1() {
                const lines = this.code.split("\n");
                let in_func = false;
                let endnum = 0;
                let funcname = "";

                for (let line of lines) {
                    const tokens = line.split(" ") || line.split("\t");

                    if (tokens.length > 0) {
                        const token = tokens[0];

                        if (!in_func) {
                            if (token === "fnc") {
                                funcname = tokens[1];
                                if (tokens[2] === "[") {
                                    endnum += 1;
                                    in_func = true;
                                    functions[funcname] = [];
                                }
                            } else if (token === "&&" || token === "") {
                                continue;
                            } else {
                                throw new Error("Error: You can only create functions outside of a function");
                            }
                        } else {
                            if (token === "if" || token === "while") {
                                endnum += 1;
                                functions[funcname].push(line);
                            } else if (token === "]") {
                                if (endnum > 0) {
                                    endnum -= 1;
                                    functions[funcname].push(line);
                                }
                                if (endnum === 0) {
                                    in_func = false;
                                }
                            } else {
                                functions[funcname].push(line);
                            }
                        }
                    }
                }
                if (functions["main"]) {
                    new Executor(functions["main"].join("\n")).execute2();
                }
            }

            execute2() {
                const lines = this.code.split("\n");
                let in_if = false;
                let varname1 = "";
                let operation = "";
                let varname2 = "";
                let ifcode = [];
                let endnum = 0;
                let in_while = false;
                let while_code = [];

                for (let line of lines) {
                    const tokens = line.split(" ") || line.split("\t");

                    if (tokens.length > 0) {
                        const token = tokens[0];

                        if (!in_if && !in_while) {
                            if (token === "showln") {
                                if (tokens[1] === "\"") {
                                    if (tokens[tokens.length - 1] === "\"") {
                                        const msg = tokens.slice(2, tokens.length - 1).join(" ");
                                        this.printOutput(msg);
                                    } else {
                                        throw new Error("Error: use \" to close a string");
                                    }
                                } else if (tokens[1] === "\\n") {
                                    this.printOutput("\n");
                                } else if (tokens[1] === "\\spc") {
                                    this.printOutput(" ");
                                } else {
                                    this.printOutput(variables[tokens[1]]);
                                }
                            } else if (token === "int") {
                                const varname = tokens[1];
                                if (tokens[2] === ":") {
                                    const value = parseInt(tokens[3]);
                                    variables[varname] = value;
                                } else {
                                    throw new Error("Error: use : to attribute a value to a variable");
                                }
                            } else if (token === "string") {
                                const varname = tokens[1];
                                if (tokens[2] === ":") {
                                    const value = tokens.slice(3).join(" ");
                                    variables[varname] = value;
                                } else {
                                    throw new Error("Error: use : to attribute a value to a variable");
                                }
                            } else if (token === "call") {
                                const funcname = tokens[1];
                                new Executor(functions[funcname].join("\n")).execute2();
                            } else if (token === "if") {
                                varname1 = tokens[1];
                                operation = tokens[2];
                                if (tokens.length === 5) {
                                    varname2 = tokens[3];
                                    if (tokens[4] === "[") {
                                        in_if = true;
                                        endnum += 1;
                                        ifcode = [];
                                    }
                                } else {
                                    if (operation === "[") {
                                        in_if = true;
                                        endnum += 1;
                                        ifcode = [];
                                    }
                                }
                            } else if (token === "bool") {
                                const varname = tokens[1];
                                if (tokens[2] === ":") {
                                    if (tokens[3] === "ok") {
                                        variables[varname] = true;
                                    } else if (tokens[3] === "no") {
                                        variables[varname] = false;
                                    } else {
                                        throw new Error("Error: use 'ok' or 'no' ('ok' = true, 'no' = false)");
                                    }
                                } else {
                                    throw new Error("Error: use : to attribute a value to a variable");
                                }
                            } else if (token === "while") {
                                if (tokens[1] === "[") {
                                    in_while = true;
                                    while_code = [];
                                    endnum += 1;
                                    running_while = true;
                                } else {
                                    throw new Error("Error: use [ to open a while loop");
                                }
                            } else if (token === "stop") {
                                running_while = false;
                            } else if (token === "mod") {
                                const varname1 = tokens[1];
                                if (tokens[2] === "<") {
                                    const varname2 = tokens[3];
                                    variables[varname1] += variables[varname2];
                                } else {
                                    throw new Error("Error: use < to modify the second variable to the first variable");
                                }
                            } else if (token === "input") {
                                const inputType = tokens[1];
                                if (inputType === "int") {
                                    const varname = tokens[2];
                                    variables[varname] = parseInt(prompt("Enter an integer:"));
                                } else if (inputType === "string") {
                                    const varname = tokens[2];
                                    variables[varname] = prompt("Enter a string:");
                                }
                            } else if (token === "float") {
                                const varname = tokens[1];
                                if (tokens[2] === ":") {
                                    const value = parseFloat(tokens[3]);
                                    variables[varname] = value;
                                } else {
                                    throw new Error("Error: use : to attribute a value to a variable");
                                }
                            } else if (token === "rand") {
                                const varname1 = tokens[1];
                                const varname2 = tokens[2];
                                const outputvar = tokens[3];
                                variables[outputvar] = randint(variables[varname1], variables[varname2]);
                            } else if (token === "list") {
                                const varname = tokens[1];
                                variables[varname] = [];
                            } else if (token === "listapp") {
                                const listvarname = tokens[1];
                                const varname = tokens[2];
                                variables[listvarname].push(variables[varname]);
                            } else if (token === "listpop") {
                                const listvarname = tokens[1];
                                variables[listvarname].pop();
                            } else if (token === "getlistitem") {
                                const listvarname = tokens[1];
                                const itempos = tokens[2];
                                const outputvar = tokens[4];
                                if (tokens[3] === ">") {
                                    if (!isNaN(itempos)) {
                                        variables[outputvar] = variables[listvarname][parseInt(itempos)];
                                    } else {
                                        variables[outputvar] = variables[listvarname][variables[itempos]];
                                    }
                                } else {
                                    throw new Error("Error: use > to reference the output variable");
                                }
                            } else if (token === "split") {
                                const varname = tokens[1];
                                const listvarname = tokens[2];
                                variables[listvarname] = variables[varname].split(" ");
                            } else if (token === "&&" || token === "") {
                                continue;
                            } else {
                                throw new Error(`Error: unknown token: ${token}`);
                            }
                        } else if (in_if) {
                            if (token === "if" || token === "while") {
                                endnum += 1;
                                ifcode.push(line);
                            } else if (token === "]") {
                                if (endnum > 0) {
                                    endnum -= 1;
                                    ifcode.push(line);
                                }
                                if (endnum === 0) {
                                    in_if = false;
                                    if (operation === "=" && variables[varname1] === variables[varname2]) {
                                        new Executor(ifcode.join("\n")).execute2();
                                    } else if (operation === "!" && variables[varname1] !== variables[varname2]) {
                                        new Executor(ifcode.join("\n")).execute2();
                                    } else if (operation === ">>" && variables[varname1] >= variables[varname2]) {
                                        new Executor(ifcode.join("\n")).execute2();
                                    } else if (operation === "<<" && variables[varname1] <= variables[varname2]) {
                                        new Executor(ifcode.join("\n")).execute2();
                                    } else if (operation === ">" && variables[varname1] > variables[varname2]) {
                                        new Executor(ifcode.join("\n")).execute2();
                                    } else if (operation === "<" && variables[varname1] < variables[varname2]) {
                                        new Executor(ifcode.join("\n")).execute2();
                                    } else if (operation === "[" && variables[varname1]) {
                                        new Executor(ifcode.join("\n")).execute2();
                                    }
                                }
                            } else {
                                ifcode.push(line);
                            }
                        } else if (in_while) {
                            if (token === "if" || token === "while") {
                                endnum += 1;
                                while_code.push(line);
                            } else if (token === "]") {
                                if (endnum > 0) {
                                    endnum -= 1;
                                    while_code.push(line);
                                }
                                if (endnum === 0) {
                                    in_while = false;
                                    while (running_while) {
                                        new Executor(while_code.join("\n")).execute2();
                                    }
                                }
                            } else {
                                while_code.push(line);
                            }
                        }
                    }
                }
            }

            printOutput(msg) {
                const outputElement = document.getElementById("output");
                outputElement.textContent += msg;
            }
        }

        document.getElementById("executeButton").addEventListener("click", () => {
            const code = document.getElementById("codeEditor").value;
            try {
                new Executor(code).execute1();
            } catch (e) {
                alert(e.message);
            }
        });
    </script>
</body>
</html>
